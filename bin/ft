#!/usr/bin/env node

const Menu = require('../lib/ui/menu');
const Scrollable = require('../lib/ui/scrollable');

const sections = require('../controllers/sections');
const list = require('../controllers/curated-list');
const article = require('../controllers/article');

const spinner = require('ora')('Loadingâ€¦');

const app = async () => {
	const sectionParams = await sections();

	const selectedSection = await new Promise((resolve) => {
		new Menu(sectionParams.prompt, sectionParams.choices, { callback: resolve });
	});

	spinner.start();

	const listParams = await list(selectedSection.uuid);

	spinner.stop();

	const selectedArticle = await new Promise((resolve) => {
		new Menu(listParams.prompt, listParams.choices, { callback: resolve });
	});

	spinner.start();

	const articleParams = await article(selectedArticle.uuid);

	spinner.stop();

	await new Promise((resolve) => {
		new Scrollable(articleParams, { callback: resolve });
	});

	return app();
};

const task = () => (
	Promise.resolve()

	.then(() => {
		return app();
	})

	.then(() => {
		process.exit();
	})
	.catch((error) => {
		if (spinner.isSpinning) {
			spinner.fail();
		}

		console.error(error);

		process.stderr.write(`Oh no, something went wrong: ${error}\n`);
		process.exit(1);
	})
);

task();
